Bootstrap: docker
From: nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export UV_LINK_MODE=copy
    export UV_TOOL_BIN_DIR=/usr/local/bin
    export CUDA_NAME=cu128
    export PATH="/workspace/.venv/bin:$PATH"

%files
    # Copy the current directory to /workspace in the container
    . /workspace

%post
    export DEBIAN_FRONTEND=noninteractive
    export UV_LINK_MODE=copy
    export UV_TOOL_BIN_DIR=/usr/local/bin
    export CUDA_NAME=cu128
    export PATH="/workspace/.venv/bin:$PATH"

    # Install packages
    apt-get update
    apt-get install -y --no-install-recommends \
        curl \
        ffmpeg \
        git \
        git-lfs \
        tree \
        wget \
        ca-certificates

    # Install uv
    # Mimicking COPY --from=ghcr.io/astral-sh/uv:0.8.12 /uv /uvx /usr/local/bin/
    # Downloading binaries from GitHub release for version 0.8.12
    UV_VERSION=0.8.12
    ARCH=x86_64-unknown-linux-gnu
    wget -qO- https://github.com/astral-sh/uv/releases/download/${UV_VERSION}/uv-${ARCH}.tar.gz | tar -xz -C /tmp
    mv /tmp/uv-${ARCH}/uv /usr/local/bin/
    mv /tmp/uv-${ARCH}/uvx /usr/local/bin/
    rm -rf /tmp/uv-${ARCH}

    # Install just
    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin --tag 1.42.4

    # Setup workspace working directory
    cd /workspace

    # Install the project's dependencies
    # We assume 'standalone' mode for Singularity image (files are copied in %files)
    
    # 1. Sync dependencies (without installing the project package itself yet)
    uv sync --locked --no-install-project --extra=${CUDA_NAME}

    # 2. Install the project
    # Replicating: if [ "$STANDALONE" = "true" ] ; then cp -r /tmp/workspace/* /workspace && just install && rm -rf /workspace/.git ...
    # Since we mapped . to /workspace directly in %files, we are effectively in standalone mode.
    just install
    
    # Disable runtime uv sync in entrypoint to ensure no runtime dependencies are installed/checked
    sed -i 's/^uv sync/# uv sync/g' /workspace/bin/entrypoint.sh

    # Cleanup git folder if desired, following Dockerfile pattern
    rm -rf .git

%runscript
    exec /workspace/bin/entrypoint.sh "$@"

%labels
    Author NVIDIA
    License Apache-2.0
